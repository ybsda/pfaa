{% extends "base.html" %}

{% block title %}Dashboard - Camera Monitoring System{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-content">
                    <div class="stats-number">{{ total_cameras }}</div>
                    <div class="stats-label">Total Cameras</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-video"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card stats-success">
                <div class="stats-content">
                    <div class="stats-number">{{ online_cameras }}</div>
                    <div class="stats-label">Online</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card stats-warning">
                <div class="stats-content">
                    <div class="stats-number">{{ offline_cameras }}</div>
                    <div class="stats-label">Offline</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card stats-danger">
                <div class="stats-content">
                    <div class="stats-number">{{ error_cameras }}</div>
                    <div class="stats-label">Errors</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Camera Grid -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-camera"></i> Camera Feeds</h5>
                    <a href="{{ url_for('cameras') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-cog"></i> Manage
                    </a>
                </div>
                <div class="card-body">
                    {% if cameras %}
                    <div class="camera-grid">
                        {% for camera in cameras[:8] %}
                        <div class="camera-feed">
                            <div class="feed-header">
                                <span class="camera-name">{{ camera.name }}</span>
                                <span class="status-badge status-{{ camera.status }}">
                                    <i class="fas fa-circle"></i> {{ camera.status|title }}
                                </span>
                            </div>
                            <div class="feed-content">
                                {% if camera.status == 'online' %}
                                <div class="mock-feed">
                                    <i class="fas fa-video feed-icon"></i>
                                    <div class="feed-overlay">
                                        <div class="timestamp">{{ moment().format('HH:mm:ss') }}</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="feed-offline">
                                    <i class="fas fa-video-slash"></i>
                                    <p>Camera Offline</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="feed-footer">
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt"></i> {{ camera.location }}
                                </small>
                                <small class="text-muted">
                                    {% if camera.last_seen %}
                                    Last seen: {{ moment(camera.last_seen).fromNow() }}
                                    {% else %}
                                    Never connected
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-camera text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">No Cameras Found</h5>
                        <p class="text-muted">Add your first camera to start monitoring</p>
                        <a href="{{ url_for('cameras') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Camera
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- System Health -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-heartbeat"></i> System Health</h6>
                </div>
                <div class="card-body">
                    {% for metric in system_health %}
                    <div class="health-metric">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{{ metric.metric }}</span>
                            <span class="badge bg-{{ 'success' if metric.status == 'normal' else 'warning' }}">
                                {{ metric.value }}
                            </span>
                        </div>
                        <div class="progress mt-1">
                            <div class="progress-bar bg-{{ 'success' if metric.status == 'normal' else 'warning' }}" 
                                 style="width: {{ metric.value.replace('%', '') }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-bell"></i> Recent Alerts</h6>
                </div>
                <div class="card-body">
                    {% if recent_alerts %}
                    <div class="alert-list">
                        {% for alert in recent_alerts[:5] %}
                        <div class="alert-item {{ 'acknowledged' if alert.acknowledged else '' }}">
                            <div class="alert-icon">
                                <i class="fas fa-{{ 'exclamation-triangle' if alert.severity == 'warning' else 'times-circle' if alert.severity == 'error' else 'info-circle' }}"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-message">{{ alert.message }}</div>
                                <small class="text-muted">
                                    {{ moment(alert.created_at).fromNow() }} - {{ alert.camera.name }}
                                </small>
                            </div>
                            {% if not alert.acknowledged %}
                            <form method="POST" action="{{ url_for('acknowledge_alert', alert_id=alert.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Acknowledge">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0 text-muted">No recent alerts</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh camera status every 30 seconds
setInterval(() => {
    fetch('/api/camera-status')
        .then(response => response.json())
        .then(data => {
            data.forEach(camera => {
                const feedElement = document.querySelector(`[data-camera-id="${camera.id}"]`);
                if (feedElement) {
                    const statusBadge = feedElement.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${camera.status}`;
                        statusBadge.innerHTML = `<i class="fas fa-circle"></i> ${camera.status.charAt(0).toUpperCase() + camera.status.slice(1)}`;
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching camera status:', error));
}, 30000);
</script>
{% endblock %}
